<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>IoT Dashboard - Smart Agriculture</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }

    :root{
      --primary-color:#00d4aa;
      --secondary-color:#e8f5f0;
      --text-dark:#2c3e50;
      --text-light:#7f8c8d;
      --white:#ffffff;
      --border-color:#e1e8ed;
      --background:#f8fafc;
      --card-bg:#ffffff;
      --shadow:0 2px 10px rgba(0,0,0,.1);
      --shadow-hover:0 4px 20px rgba(0,0,0,.12);
      --border-radius:12px;
      --navbar-height:70px;
    }

    [data-theme="dark"]{
      --text-dark:#e2e8f0;
      --text-light:#94a3b8;
      --white:#1e293b;
      --border-color:#334155;
      --background:#0f172a;
      --card-bg:#1e293b;
      --shadow:0 2px 10px rgba(0,0,0,.3);
      --shadow-hover:0 4px 20px rgba(0,0,0,.4);
      --secondary-color:rgba(0,212,170,.1);
    }

    body{
      font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
      background:var(--background);
      color:var(--text-dark);
      line-height:1.6;
      transition:all .3s ease;
      padding-top:var(--navbar-height);
      min-height:100vh;
    }

    /* Navbar */
    .navbar{
      position:fixed; inset:0 0 auto 0; height:var(--navbar-height);
      background:var(--card-bg); border-bottom:1px solid var(--border-color);
      box-shadow:var(--shadow); z-index:1000;
    }
    .navbar-content{
      max-width:1200px; margin:0 auto; height:100%;
      display:flex; align-items:center; justify-content:space-between; padding:0 20px;
    }
    .navbar-left{ display:flex; align-items:center; gap:12px; }
    .navbar-logo{
      width:40px; height:40px; background:linear-gradient(135deg,var(--primary-color),#00c4a7);
      border-radius:10px; display:flex; align-items:center; justify-content:center; color:#fff; font-size:18px;
    }
    .navbar-title{ font-size:1.4rem; font-weight:700; color:var(--text-dark); }
    .navbar-subtitle{ font-size:.8rem; color:var(--text-light); margin-left:2px; }

    .navbar-right{ display:flex; align-items:center; gap:12px; }
    .connection-info{ display:flex; flex-direction:column; gap:4px; }
    .connection-status{
      display:flex; align-items:center; gap:8px; padding:6px 12px; border-radius:16px;
      font-size:.8rem; font-weight:500;
    }
    .connection-status.connected{ background:var(--secondary-color); color:var(--primary-color); }
    .connection-status.disconnected{ background:rgba(220,53,69,.1); color:#dc3545; }
    .connection-status.connecting{ background:rgba(255,193,7,.1); color:#ffc107; }
    .connection-details{ display:flex; flex-direction:column; gap:2px; font-size:.7rem; color:var(--text-light); }
    .broker-info,.client-info{ font-family:monospace; }

    .btn-ico{
      background:none; border:1px solid var(--border-color); color:var(--text-dark);
      width:40px; height:40px; border-radius:10px; display:flex; align-items:center; justify-content:center;
      cursor:pointer; transition:all .2s ease; font-size:16px;
    }
    .btn-ico:hover{ background:var(--secondary-color); border-color:var(--primary-color); color:var(--primary-color); }
    .btn-ico.primary{ background:var(--primary-color); color:#fff; border-color:var(--primary-color); }
    .btn-ico.primary:hover{ background:#00c4a7; transform:scale(1.03); }
    .btn-ico.warn{ background:#f59e0b; color:#fff; border-color:#f59e0b; }
    .btn-ico.warn:hover{ background:#d97706; }

    /* Main */
    .container{ max-width:1200px; margin:0 auto; padding:20px; min-height:calc(100vh - var(--navbar-height)); }
    .page-header{ margin-bottom:24px; }
    .page-title{ font-size:1.8rem; font-weight:600; color:var(--text-dark); margin-bottom:8px; }
    .page-subtitle{ color:var(--text-light); font-size:.95rem; }

    .dashboard-grid{
      display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
      gap:20px; margin-bottom:24px;
    }

    .card{
      background:var(--card-bg); border:1px solid var(--border-color);
      border-radius:var(--border-radius); padding:24px; box-shadow:var(--shadow);
      transition:box-shadow .2s ease, transform .2s ease; position:relative;
    }
    .card:hover{ box-shadow:var(--shadow-hover); transform:translateY(-2px); }
    .card-header{ display:flex; align-items:center; margin-bottom:20px; }
    .card-icon{
      width:44px; height:44px; border-radius:10px; display:flex; align-items:center; justify-content:center;
      margin-right:12px; font-size:18px; color:#fff;
    }
    .card.temperature .card-icon{ background:linear-gradient(135deg,#ff6b6b,#ee5a52); }
    .card.humidity .card-icon{ background:linear-gradient(135deg,#4ecdc4,#44a08d); }
    .card.ph .card-icon{ background:linear-gradient(135deg,#45b7d1,#3498db); }
    .card.control .card-icon{ background:linear-gradient(135deg,var(--primary-color),#00c4a7); }

    .card-title{ font-size:1rem; font-weight:600; color:var(--text-dark); margin-bottom:2px; }
    .card-subtitle{ font-size:.85rem; color:var(--text-light); }

    .value-display{ text-align:center; margin:24px 0; }
    .main-value{ font-size:2.5rem; font-weight:700; color:var(--text-dark); line-height:1; margin-bottom:4px; }
    .unit{ font-size:1rem; color:var(--text-light); font-weight:500; }

    .status-badge{
      display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius:16px;
      font-size:.8rem; font-weight:500; margin-top:12px;
    }
    .status-badge.normal{ background:rgba(46,125,46,.1); color:#2e7d2e; }
    .status-badge.warning{ background:rgba(255,193,7,.1); color:#856404; }
    .status-badge.danger{ background:rgba(220,53,69,.1); color:#721c24; }

    [data-theme="dark"] .status-badge.normal{ background:rgba(34,197,94,.2); color:#4ade80; }
    [data-theme="dark"] .status-badge.warning{ background:rgba(251,191,36,.2); color:#fbbf24; }
    [data-theme="dark"] .status-badge.danger{ background:rgba(239,68,68,.2); color:#f87171; }

    .progress-container{ position:relative; width:100px; height:100px; margin:20px auto; }
    .progress-circle{ width:100%; height:100%; transform:rotate(-90deg); }
    .progress-circle circle{ fill:none; stroke-width:6; stroke-linecap:round; }
    .progress-bg{ stroke:var(--border-color); }
    .progress-value{ stroke:var(--primary-color); stroke-dasharray:283; stroke-dashoffset:283; transition:stroke-dashoffset .8s ease; }
    .progress-text{
      position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
      font-size:1.4rem; font-weight:700; color:var(--text-dark);
    }

    .toggle-container{ display:flex; flex-direction:column; align-items:center; gap:16px; }
    .toggle-switch{ position:relative; width:60px; height:32px; cursor:pointer; }
    .toggle-input{ opacity:0; width:0; height:0; }
    .toggle-slider{
      position:absolute; inset:0; background:var(--border-color); transition:.3s; border-radius:32px;
    }
    .toggle-slider:before{
      position:absolute; content:""; height:24px; width:24px; left:4px; bottom:4px; background:var(--card-bg);
      transition:.3s; border-radius:50%; box-shadow:0 2px 5px rgba(0,0,0,.2);
    }
    .toggle-input:checked + .toggle-slider{ background:var(--primary-color); }
    .toggle-input:checked + .toggle-slider:before{ transform:translateX(28px); }

    .pump-status{ font-size:.9rem; font-weight:600; display:flex; align-items:center; gap:8px; }
    .pump-status.on{ color:var(--primary-color); }
    .pump-status.off{ color:var(--text-light); }

    .card.logs .card-icon{ background:linear-gradient(135deg,#6c5ce7,#a29bfe); }
    .log-list{ list-style:none; max-height:200px; overflow-y:auto; font-size:.85rem; color:var(--text-light); margin-top:8px; }
    .log-list li{ padding:4px 0; border-bottom:1px solid var(--border-color); }
    .log-list li:last-child{ border-bottom:none; }

    /* Schedule */
    .schedule-container{
      background:var(--card-bg); border:1px solid var(--border-color); border-radius:var(--border-radius);
      padding:24px; box-shadow:var(--shadow); margin-bottom:24px; overflow:hidden;
    }
    .schedule-header{ display:flex; align-items:center; justify-content:space-between; margin-bottom:20px; }
    .schedule-tabs{ display:flex; gap:8px; margin-bottom:20px; flex-wrap:wrap; }
    .tab-btn{
      padding:8px 16px; border:1px solid var(--border-color); background:none; color:var(--text-light);
      border-radius:6px; font-size:.9rem; cursor:pointer;
    }
    .tab-btn.active{ background:var(--primary-color); color:#fff; border-color:var(--primary-color); }
    .tab-content{ display:none; }
    .tab-content.active{ display:block; }

    .form-group{ margin-bottom:16px; }
    .form-group label{ display:block; margin-bottom:6px; font-weight:500; color:var(--text-dark); font-size:.9rem; }
    .form-input{
      width:100%; padding:10px 12px; border:1px solid var(--border-color); border-radius:6px;
      background:var(--card-bg); color:var(--text-dark); font-size:.9rem;
    }
    .form-input:focus{ outline:none; border-color:var(--primary-color); box-shadow:0 0 0 3px rgba(0,212,170,.1); }
    .form-row{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }

    .schedule-btn{
      width:100%; padding:12px; background:var(--primary-color); color:#fff; border:none; border-radius:6px;
      font-weight:500; cursor:pointer;
    }
    .schedule-btn:hover{ background:#00c4a7; }
    .schedule-btn:disabled{ background:var(--border-color); cursor:not-allowed; }

    .schedule-status{
      padding:12px; border-radius:6px; font-size:.9rem; margin-bottom:12px; display:flex; align-items:center; gap:8px;
    }
    .schedule-status.active{ background:rgba(46,125,46,.1); color:#2e7d2e; }
    .schedule-status.inactive{ background:rgba(220,53,69,.1); color:#721c24; }
    .schedule-status.running{ background:rgba(0,212,170,.1); color:var(--primary-color); }

    .timeleft{ display:none; margin:8px 0 16px 0; padding:10px 12px; border-radius:6px; border:1px dashed var(--border-color); font-size:.9rem; color:var(--text-dark); }

    /* Charts */
    .stats-container{
      background:var(--card-bg); border:1px solid var(--border-color); border-radius:var(--border-radius);
      padding:24px; box-shadow:var(--shadow); margin-bottom:24px; overflow:hidden;
    }
    .stats-header{ display:flex; align-items:center; justify-content:space-between; margin-bottom:20px; gap:8px; flex-wrap:wrap; }
    .stats-title{ font-size:1.1rem; font-weight:600; color:var(--text-dark); }
    .stats-subtitle{ color:var(--text-light); font-size:.85rem; }
    .time-selector{ display:flex; gap:8px; flex-wrap:wrap; }
    .time-btn{
      padding:4px 12px; border:1px solid var(--border-color); background:none; color:var(--text-light);
      border-radius:6px; font-size:.8rem; cursor:pointer;
    }
    .time-btn.active{ background:var(--primary-color); color:#fff; border-color:var(--primary-color); }

    .chart-placeholder{
      height:300px; background:var(--card-bg); border:2px dashed var(--border-color); border-radius:8px;
      display:flex; flex-direction:column; align-items:center; justify-content:center; color:var(--text-light);
      position:relative; padding:16px; overflow:hidden;
    }
    .chart-placeholder.has-data{ border:1px solid var(--border-color); }
    .chart-placeholder canvas{ width:100% !important; height:100% !important; max-height:260px; }

    .no-data-warning{
      background:rgba(255,193,7,.1); border:1px solid rgba(255,193,7,.3); border-radius:8px;
      padding:16px; margin-bottom:16px; display:flex; align-items:center; gap:12px; color:#856404;
    }

    .footer-info{ background:var(--card-bg); border:1px solid var(--border-color); border-radius:var(--border-radius); padding:16px; text-align:center; }
    .last-update{ color:var(--text-light); font-size:.85rem; display:flex; align-items:center; justify-content:center; gap:8px; }

    @media (max-width:768px){
      .container{ padding:16px; }
      .dashboard-grid{ grid-template-columns:1fr; gap:16px; }
      .navbar-content{ padding:0 16px; }
      .connection-details{ display:none; }
      .time-selector{ display:none; }
      .form-row{ grid-template-columns:1fr; }
    }
    @media (max-width:480px){
      .navbar-content{ padding:0 12px; }
      .navbar-right{ gap:8px; }
      .connection-info{ display:none; }
      .dashboard-grid{ grid-template-columns:1fr; gap:12px; }
      .progress-container{ width:80px; height:80px; }
    }

    *{ transition:background-color .2s ease, color .2s ease, border-color .2s ease, box-shadow .2s ease; }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar">
    <div class="navbar-content">
      <div class="navbar-left">
        <div class="navbar-logo"><i class="fas fa-seedling"></i></div>
        <div>
          <div class="navbar-title">Smart Agriculture</div>
          <div class="navbar-subtitle">IoT Dashboard</div>
        </div>
      </div>
      <div class="navbar-right">
        <div class="connection-info" id="connectionInfo">
          <div class="connection-status connecting" id="connectionStatus">
            <i class="fas fa-circle-notch fa-spin"></i><span>Connecting...</span>
          </div>
          <div class="connection-details" id="connectionDetails">
            <div class="broker-info" id="brokerInfo">-</div>
            <div class="client-info">ID: <span id="clientId">--</span></div>
          </div>
        </div>
        <button type="button" class="btn-ico" id="themeToggle" title="Toggle Dark Mode"><i class="fas fa-moon"></i></button>
        <button type="button" class="btn-ico primary" id="refreshBtn" title="Refresh Data"><i class="fas fa-sync-alt"></i></button>
        <button type="button" class="btn-ico warn" id="reconnectBtn" title="Reconnect MQTT"><i class="fas fa-plug"></i></button>
      </div>
    </div>
  </nav>

  <div class="container">
    <!-- Header -->
    <div class="page-header">
      <h1 class="page-title">Dashboard Overview</h1>
      <p class="page-subtitle">Real-time monitoring and control system for your smart agriculture setup</p>
    </div>

    <!-- Dashboard Grid -->
    <div class="dashboard-grid">
      <div class="no-data-warning" id="noDataWarning" style="display:none; grid-column: 1 / -1;">
        <i class="fas fa-exclamation-triangle"></i>
        <div>
          <strong>No Real-Time Data Available</strong><br>
          <small>Connect your ESP32 device to MQTT broker to see live sensor readings</small>
        </div>
      </div>

      <!-- Temperature -->
      <div class="card temperature">
        <div class="card-header">
          <div class="card-icon"><i class="fas fa-thermometer-half"></i></div>
          <div>
            <div class="card-title">Temperature</div>
            <div class="card-subtitle">Ambient Temperature</div>
          </div>
        </div>
        <div class="value-display">
          <div class="main-value" id="tempValue">--</div>
          <div class="unit">°C</div>
          <div class="status-badge normal" id="tempStatus"><i class="fas fa-question-circle"></i> No Data</div>
        </div>
      </div>

      <!-- Soil Moisture -->
      <div class="card humidity">
        <div class="card-header">
          <div class="card-icon"><i class="fas fa-tint"></i></div>
          <div>
            <div class="card-title">Soil Moisture</div>
            <div class="card-subtitle">Kelembapan Tanah</div>
          </div>
        </div>
        <div class="progress-container">
          <svg class="progress-circle" viewBox="0 0 100 100" aria-hidden="true">
            <circle class="progress-bg" cx="50" cy="50" r="45"></circle>
            <circle class="progress-value" cx="50" cy="50" r="45" id="humidityProgress"></circle>
          </svg>
          <div class="progress-text" id="humidityValue">--%</div>
        </div>
        <div style="text-align:center;">
          <div class="status-badge normal" id="humidityStatus"><i class="fas fa-question-circle"></i> No Data</div>
        </div>
      </div>

      <!-- pH -->
      <div class="card ph">
        <div class="card-header">
          <div class="card-icon"><i class="fas fa-flask"></i></div>
          <div>
            <div class="card-title">pH Level</div>
            <div class="card-subtitle">Water Acidity</div>
          </div>
        </div>
        <div class="value-display">
          <div class="main-value" id="phValue">--</div>
          <div class="unit">pH</div>
          <div class="status-badge normal" id="phStatus"><i class="fas fa-question-circle"></i> No Data</div>
        </div>
      </div>

      <!-- Relay Control -->
      <div class="card control">
        <div class="card-header">
          <div class="card-icon"><i class="fas fa-cog"></i></div>
          <div>
            <div class="card-title">Water Pump</div>
            <div class="card-subtitle">Relay Control</div>
          </div>
        </div>
        <div class="toggle-container">
          <label class="toggle-switch">
            <input type="checkbox" class="toggle-input" id="pumpToggle"/>
            <span class="toggle-slider"></span>
          </label>
          <div class="pump-status off" id="pumpStatus"><i class="fas fa-power-off"></i> PUMP OFF</div>
        </div>
      </div>

      <!-- Event Logs -->
      <div class="card logs">
        <div class="card-header">
          <div class="card-icon"><i class="fas fa-clipboard-list"></i></div>
          <div>
            <div class="card-title">Event Logs</div>
            <div class="card-subtitle">Pump & Schedule</div>
          </div>
        </div>
        <ul id="logList" class="log-list"></ul>
      </div>
    </div>

    <!-- Schedule -->
    <div class="schedule-container">
      <div class="schedule-header">
        <div>
          <div class="stats-title">Relay Schedule & Automation</div>
          <div class="stats-subtitle">Set up automatic watering schedules</div>
        </div>
      </div>

      <div class="schedule-tabs" id="scheduleTabs">
        <button type="button" class="tab-btn active" data-tab="manual">Manual Control</button>
        <button type="button" class="tab-btn" data-tab="time">Time Schedule</button>
        <button type="button" class="tab-btn" data-tab="moisture">Moisture Control</button>
      </div>

      <!-- Manual -->
      <div class="tab-content active" id="manual-tab">
        <div class="schedule-status inactive" id="manualStatus">
          <i class="fas fa-hand-paper"></i>
          <span>Manual mode active - Use toggle above to control relay</span>
        </div>
      </div>

      <!-- Time Schedule -->
      <div class="tab-content" id="time-tab">
        <div class="schedule-status inactive" id="timeScheduleStatus">
          <i class="fas fa-clock"></i>
          <span>No schedule set</span>
        </div>

        <!-- TIME LEFT -->
        <div class="timeleft" id="timeLeftBox">
          <i class="fas fa-hourglass-half"></i>
          <span id="timeLeftText">Time left: --:--:--</span>
        </div>

        <div class="form-group">
          <label for="timeScheduleEnable">
            <input type="checkbox" id="timeScheduleEnable"> Enable Time Schedule
          </label>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="scheduleHour">Start Time (Hour)</label>
            <input type="number" id="scheduleHour" class="form-input" min="0" max="23" value="7" placeholder="0-23">
          </div>
          <div class="form-group">
            <label for="scheduleMinute">Start Time (Minute)</label>
            <input type="number" id="scheduleMinute" class="form-input" min="0" max="59" value="0" placeholder="0-59">
          </div>
        </div>

        <div class="form-group">
          <label for="scheduleDuration">Duration (minutes)</label>
          <input type="number" id="scheduleDuration" class="form-input" min="1" max="120" value="15" placeholder="1-120">
        </div>

        <button type="button" class="schedule-btn" id="setTimeSchedule">Set Time Schedule</button>
      </div>

      <!-- Moisture Control -->
      <div class="tab-content" id="moisture-tab">
        <div class="schedule-status inactive" id="moistureStatus">
          <i class="fas fa-tint"></i>
          <span>Moisture automation disabled</span>
        </div>

        <div class="form-group">
          <label for="moistureAutoEnable">
            <input type="checkbox" id="moistureAutoEnable"> Enable Moisture Control
          </label>
        </div>

        <div class="form-group">
          <label for="moistureThreshold">Turn ON when moisture below (%)</label>
          <input type="number" id="moistureThreshold" class="form-input" min="10" max="90" value="30" placeholder="10-90">
        </div>

        <div class="form-group">
          <label for="moistureTarget">Turn OFF when moisture above (%)</label>
          <input type="number" id="moistureTarget" class="form-input" min="20" max="95" value="70" placeholder="20-95">
        </div>

        <button type="button" class="schedule-btn" id="setMoistureControl">Set Moisture Control</button>
      </div>
    </div>

    <!-- Charts -->
    <div class="stats-container">
      <div class="stats-header">
        <div>
          <div class="stats-title">Historical Data</div>
          <div class="stats-subtitle">Sensor readings over time</div>
        </div>
        <div class="time-selector">
          <button type="button" class="time-btn active" data-time="1h">1H</button>
          <button type="button" class="time-btn" data-time="6h">6H</button>
          <button type="button" class="time-btn" data-time="24h">24H</button>
          <button type="button" class="time-btn" data-time="7d">7D</button>
        </div>
      </div>
      <div class="chart-placeholder" id="chartContainer">
        <canvas id="sensorChart" width="400" height="200"></canvas>
      </div>
    </div>

    <!-- Footer -->
    <div class="footer-info">
      <div class="last-update"><i class="fas fa-clock"></i>
        <span>Last updated: <span id="lastUpdate">--</span></span>
      </div>
    </div>
  </div>

  <script>
    // ================== STATE ==================
    let mqttClient = null;
    let currentTheme = localStorage.getItem('theme') || 'light';
    let sensorData = { temperature: null, humidity: null, ph: null, pumpStatus: false };
    let eventLogs = [];
    let scheduleData = {
      timeSchedule: { enabled: false, hour: 7, minute: 0, duration_min: 15, running: false, run_until: null },
      moistureControl: { enabled: false, threshold: 30, target: 70 }
    };
    let isConnected = false;

    // Anti-bounce UI→MQTT
    let lastRelayCmd = { val: null, ts: 0 };
    const CMD_DEBOUNCE_MS = 700;

    // Time left interval
    let timeLeftTimer = null;

    // Historical data (untuk chart baru)
    let historicalData = { timestamps: [], temperature: [], humidity: [], ph: [] };
    let chart = null;
    let maxDataPoints = 60;
    let currentRange = '1h';

    // ==== HIVE MQ CLOUD (WSS TLS) + AUTH ====
    const MQTT_CONFIG = {
      host: 'd61b7602f60d488a985eb51f2e8a7e65.s1.eu.hivemq.cloud',
      port: 8884,       // WebSocket TLS
      path: '/mqtt',
      protocol: 'wss',
      clientId: 'growy-dashboard-' + Math.random().toString(16).slice(2,10)
    };
    const MQTT_AUTH = { username: 'manunggal', password: 'Jayaa333' };

    const MQTT_TOPICS = {
      relaySet: 'growy/relay/set',
      relayState: 'growy/relay/state',
      scheduleSet: 'growy/relay/schedule/set',
      scheduleState: 'growy/relay/schedule/state',
      telemetry: 'growy/telemetry'
    };

    // ================== INIT ==================
    document.addEventListener('DOMContentLoaded', () => {
      initializeDashboard();
      initializeMQTT();
      initializeChart();     // chart versi baru
      updateChartTimeRange('1h');  // load initial chart data
    });

    // ================== UI BASICS ==================
    function setTheme(theme){
      document.documentElement.setAttribute('data-theme', theme);
      const icon = document.querySelector('#themeToggle i');
      if(icon){ icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon'; }
      localStorage.setItem('theme', theme);
    }
    function toggleTheme(){ setTheme(document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light'); }
    function updateLastUpdateTime(){ const el=document.getElementById('lastUpdate'); if(el) el.textContent = isConnected ? new Date().toLocaleString() : 'No connection'; }

    function initializeDashboard(){
      setTheme(currentTheme);
      document.getElementById('themeToggle')?.addEventListener('click', toggleTheme);
      document.getElementById('refreshBtn')?.addEventListener('click', ()=>{ updateLastUpdateTime(); });
      document.getElementById('reconnectBtn')?.addEventListener('click', reconnectMQTT);

      document.getElementById('scheduleTabs')?.addEventListener('click', (e) => {
        const btn = e.target.closest('.tab-btn'); if(!btn) return;
        e.preventDefault(); switchTab(btn.dataset.tab);
      });

      document.getElementById('pumpToggle')?.addEventListener('change', function(){ togglePump(this.checked, true, 'manual'); });

      document.getElementById('setTimeSchedule')?.addEventListener('click', setTimeSchedule);
      document.getElementById('setMoistureControl')?.addEventListener('click', setMoistureControl);
      document.getElementById('timeScheduleEnable')?.addEventListener('change', function(){ if(!this.checked) disableTimeSchedule(); });
      document.getElementById('moistureAutoEnable')?.addEventListener('change', function(){ scheduleData.moistureControl.enabled=this.checked; updateMoistureStatus(); });

      document.querySelectorAll('.time-btn').forEach(btn=>btn.addEventListener('click', function(){
        document.querySelectorAll('.time-btn').forEach(b=>b.classList.remove('active'));
        this.classList.add('active'); updateChartTimeRange(this.dataset.time);
      }));

      updateConnectionStatus('connecting');
      updateBrokerInfo();
      resetSensorDisplays();
      togglePump(sensorData.pumpStatus, false);
      updateLastUpdateTime();
      updateScheduleStatuses();
      loadPumpLogs();
    }

    function switchTab(tabName) {
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      const btn = document.querySelector(`.tab-btn[data-tab="${tabName}"]`); if (btn) btn.classList.add('active');
      document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
      const panel = document.getElementById(`${tabName}-tab`); if (panel) panel.classList.add('active');
    }

    function updateBrokerInfo() {
      const brokerEl = document.getElementById('brokerInfo');
      const clientEl = document.getElementById('clientId');
      if (brokerEl) brokerEl.textContent = `${MQTT_CONFIG.protocol}://${MQTT_CONFIG.host}:${MQTT_CONFIG.port}${MQTT_CONFIG.path}`;
      if (clientEl) clientEl.textContent = MQTT_CONFIG.clientId;
    }

    function updateConnectionStatus(status){
      const el = document.getElementById('connectionStatus'); if(!el) return;
      if(status === 'connected'){ el.innerHTML = '<i class="fas fa-wifi"></i><span>Connected</span>'; el.className = 'connection-status connected'; }
      else if(status === 'disconnected'){ el.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>Disconnected</span>'; el.className = 'connection-status disconnected'; }
      else{ el.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i><span>Connecting...</span>'; el.className = 'connection-status connecting'; }
    }

    function reconnectMQTT(){ try{ mqttClient?.end(true);}catch(e){} setTimeout(initializeMQTT,600); }

    // ================== MQTT ==================
    function initializeMQTT() {
      try { mqttClient?.end(true); } catch(e) {}
      const url = `${MQTT_CONFIG.protocol}://${MQTT_CONFIG.host}:${MQTT_CONFIG.port}${MQTT_CONFIG.path}`;
      mqttClient = mqtt.connect(url, {
        clientId: MQTT_CONFIG.clientId, clean: true, connectTimeout: 10000,
        reconnectPeriod: 2000, keepalive: 30, username: MQTT_AUTH.username, password: MQTT_AUTH.password, protocolVersion: 4
      });

      mqttClient.on('connect', () => {
        isConnected = true;
        updateConnectionStatus('connected');
        const n= document.getElementById('noDataWarning'); if(n) n.style.display='none';
        mqttClient.subscribe([MQTT_TOPICS.relayState, MQTT_TOPICS.scheduleState, MQTT_TOPICS.telemetry], err => { if(err) console.error('Subscribe error:', err); });
      });
      mqttClient.on('reconnect', ()=>updateConnectionStatus('connecting'));
      mqttClient.on('error', ()=>disconnected());
      mqttClient.on('offline',()=>disconnected());
      mqttClient.on('close',  ()=>disconnected());
      mqttClient.on('message', handleMqttMessage);
    }
    function disconnected(){ isConnected=false; updateConnectionStatus('disconnected'); resetSensorDisplays(); stopTimeLeft(); }

    function handleMqttMessage(topic, message){
      let data; try{ data = JSON.parse(message.toString()); }catch(e){ return; }
      if (topic === MQTT_TOPICS.relayState){
        sensorData.pumpStatus = !!data.relay; togglePump(sensorData.pumpStatus, false, data.reason || 'other');
      } else if (topic === MQTT_TOPICS.scheduleState){
        const prevRun = scheduleData.timeSchedule.running;
        scheduleData.timeSchedule = {
          enabled: !!data.enabled, hour: data.hour, minute: data.minute, duration_min: data.duration_min,
          running: !!data.running, run_until: (data.run_until ? Number(data.run_until) : null)
        };
        updateTimeScheduleStatus();
        handleTimeLeft(scheduleData.timeSchedule.running, scheduleData.timeSchedule.run_until);
        if (prevRun !== scheduleData.timeSchedule.running) {
          sendPumpLog(scheduleData.timeSchedule.running ? 'ON' : 'OFF', 'schedule');
        }
      } else if (topic === MQTT_TOPICS.telemetry){
        if (data?.suhu != null){ sensorData.temperature = data.suhu; updateTemperature(data.suhu); addDataPoint('temperature', data.suhu); }
        if (data?.ph   != null){ sensorData.ph         = data.ph;   updatePH(data.ph);          addDataPoint('ph', data.ph); }
        if (data?.kelembapan_tanah != null){
          sensorData.humidity = data.kelembapan_tanah; updateHumidity(data.kelembapan_tanah); addDataPoint('humidity', data.kelembapan_tanah);
        }
        if (data?.relay !== undefined) { sensorData.pumpStatus = !!data.relay; togglePump(sensorData.pumpStatus, false, data.reason || 'other'); }
        sendSensorData({
          suhu: data?.suhu,
          kelembapan_tanah: data?.kelembapan_tanah,
          ph: data?.ph,
          relay: data?.relay
        });
        updateLastUpdateTime(); renderChart();
      }
    }

    function publishMqtt(topic, payload, retain=false) {
      if (mqttClient?.connected && isConnected) mqttClient.publish(topic, typeof payload==='string'?payload:JSON.stringify(payload), {qos:0, retain});
      else alert('MQTT not connected!');
    }

    function safePublishRelay(wantOn){
      const now=Date.now(); if (lastRelayCmd.val===wantOn && (now-lastRelayCmd.ts)<CMD_DEBOUNCE_MS) return;
      lastRelayCmd={val:wantOn,ts:now}; publishMqtt(MQTT_TOPICS.relaySet,{relay:!!wantOn},false);
    }

    // ================== SENSOR UI ==================
    function resetSensorDisplays(){
      const tv=document.getElementById('tempValue'); if(tv) tv.textContent='--';
      const hv=document.getElementById('humidityValue'); if(hv) hv.textContent='--%';
      const pv=document.getElementById('phValue'); if(pv) pv.textContent='--';
      const ts=document.getElementById('tempStatus'); if(ts){ ts.innerHTML='<i class="fas fa-question-circle"></i> No Data'; ts.className='status-badge normal'; }
      const hs=document.getElementById('humidityStatus'); if(hs){ hs.innerHTML='<i class="fas fa-question-circle"></i> No Data'; hs.className='status-badge normal'; }
      const ps=document.getElementById('phStatus'); if(ps){ ps.innerHTML='<i class="fas fa-question-circle"></i> No Data'; ps.className='status-badge normal'; }
      const pg=document.getElementById('humidityProgress'); if(pg){ pg.style.strokeDashoffset=283; }
      const warn=document.getElementById('noDataWarning'); if(warn){ warn.style.display = isConnected ? 'none' : 'flex'; }
    }

    function updateTemperature(value){
      if (value == null) return;
      const el = document.getElementById('tempValue'); if(el) el.textContent = value.toFixed(1);
      const status = document.getElementById('tempStatus');
      if(status){
        if(value < 20){ status.innerHTML = '<i class="fas fa-snowflake"></i> Cold'; status.className = 'status-badge warning'; }
        else if(value > 35){ status.innerHTML = '<i class="fas fa-fire"></i> Hot'; status.className = 'status-badge danger'; }
        else { status.innerHTML = '<i class="fas fa-check-circle"></i> Normal'; status.className = 'status-badge normal'; }
      }
    }

    function updateHumidity(value){
      if (value == null) return;
      const valueEl = document.getElementById('humidityValue'); const progressEl = document.getElementById('humidityProgress');
      if(valueEl) valueEl.textContent = value + '%';
      if(progressEl){ const r=45, c=2*Math.PI*r; progressEl.style.strokeDashoffset = c - (value/100*c); }
      const status = document.getElementById('humidityStatus');
      if(status){
        if(value < 30){ status.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Dry'; status.className = 'status-badge danger'; }
        else if(value > 80){ status.innerHTML = '<i class="fas fa-exclamation-circle"></i> Too Wet'; status.className = 'status-badge warning'; }
        else { status.innerHTML = '<i class="fas fa-check-circle"></i> Optimal'; status.className = 'status-badge normal'; }
      }
    }

    function updatePH(value){
      if (value == null) return;
      const el = document.getElementById('phValue'); if(el) el.textContent = value.toFixed(1);
      const status = document.getElementById('phStatus');
      if(status){
        if(value < 6.0){ status.innerHTML = '<i class="fas fa-arrow-down"></i> Acidic'; status.className = 'status-badge warning'; }
        else if(value > 8.0){ status.innerHTML = '<i class="fas fa-arrow-up"></i> Alkaline'; status.className = 'status-badge warning'; }
        else { status.innerHTML = '<i class="fas fa-balance-scale"></i> Balanced'; status.className = 'status-badge normal'; }
      }
    }

    // ================== LOGS ==================
    function addLog(message, time=null){
      const list = document.getElementById('logList');
      if(!list) return;
      const ts = time || new Date().toLocaleString();
      const item = document.createElement('li');
      item.textContent = `[${ts}] ${message}`;
      list.prepend(item);
      const max = 100;
      while(list.children.length > max){ list.removeChild(list.lastChild); }
    }

    function loadPumpLogs(){
      fetch('get_pump_logs.php?limit=20')
        .then(r=>r.json())
        .then(res=>{
          if(res.ok){
            res.data.reverse().forEach(log=>{
              const time = new Date(log.started_at.replace(' ','T')).toLocaleString();
              const msg = log.note ? log.note : `Pump ${log.action}`;
              addLog(msg, time);
            });
          }
        }).catch(()=>{});
    }

    function sendPumpLog(action, reason, durationSec=null, note=null){
      const payload = {action, reason};
      if(durationSec !== null) payload.duration_sec = durationSec;
      if(note !== null) payload.note = note;
      fetch('log_pump.php', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      }).catch(()=>{});
    }

    function sendSensorData(data){
      fetch('senddata.php', {
        method:'POST',
        headers:{'Content-Type':'application/json','X-API-Key':'GROWY_SECRET_123'},
        body: JSON.stringify(data)
      }).catch(()=>{});
    }

    // ================== RELAY ==================
    function togglePump(isOn, shouldPublish=false, reason='other'){
      const status = document.getElementById('pumpStatus');
      const toggle = document.getElementById('pumpToggle');
      if(toggle) toggle.checked = !!isOn;
      const prev = sensorData.pumpStatus;
      sensorData.pumpStatus = !!isOn;
      if(status){
        status.className = isOn ? 'pump-status on' : 'pump-status off';
        status.innerHTML = `<i class="fas fa-power-off"></i> PUMP ${isOn?'ON':'OFF'}`;
      }
      if(prev !== sensorData.pumpStatus){
        addLog(`Pump ${sensorData.pumpStatus?'ON':'OFF'}`);
        sendPumpLog(sensorData.pumpStatus?'ON':'OFF', reason);
      }
      if (shouldPublish) safePublishRelay(!!isOn);
      updateLastUpdateTime();
    }

    // ================== SCHEDULE ==================
    function setTimeSchedule() {
      const enabled = document.getElementById('timeScheduleEnable')?.checked;
      const hour = parseInt(document.getElementById('scheduleHour')?.value);
      const minute = parseInt(document.getElementById('scheduleMinute')?.value);
      const duration = parseInt(document.getElementById('scheduleDuration')?.value);

      if (!enabled) { disableTimeSchedule(); return; }
      if ([hour,minute,duration].some(x=>Number.isNaN(x)) || hour<0 || hour>23 || minute<0 || minute>59 || duration<1) {
        alert('Please enter valid values'); return;
      }

      const schedulePayload = { enable: true, hour, minute, duration_min: duration };
      scheduleData.timeSchedule = { enabled:true, hour, minute, duration_min: duration, running: false, run_until: null };
      publishMqtt(MQTT_TOPICS.scheduleSet, schedulePayload, false);
      const msg = `Schedule set for ${String(hour).padStart(2,'0')}:${String(minute).padStart(2,'0')} ${duration}min`;
      addLog(msg);
      sendPumpLog('SET', 'schedule', null, msg);
      updateTimeScheduleStatus();
      stopTimeLeft();
    }

    function disableTimeSchedule() {
      const schedulePayload = { enable: false, hour: 0, minute: 0, duration_min: 0 };
      scheduleData.timeSchedule.enabled = false;
      publishMqtt(MQTT_TOPICS.scheduleSet, schedulePayload, false);
      addLog('Schedule disabled');
      sendPumpLog('DISABLE', 'schedule', null, 'Schedule disabled');
      updateTimeScheduleStatus();
      stopTimeLeft();
    }

    function updateScheduleStatuses(){ updateTimeScheduleStatus(); updateMoistureStatus(); }

    function updateTimeScheduleStatus(){
      const el = document.getElementById('timeScheduleStatus'); if(!el) return;
      if (scheduleData.timeSchedule.enabled) {
        const t = `${String(scheduleData.timeSchedule.hour).padStart(2,'0')}:${String(scheduleData.timeSchedule.minute).padStart(2,'0')}`;
        if (scheduleData.timeSchedule.running) {
          el.innerHTML = `<i class="fas fa-play-circle"></i> Schedule running - Started at ${t} for ${scheduleData.timeSchedule.duration_min} minutes`;
          el.className='schedule-status running';
        } else {
          el.innerHTML = `<i class="fas fa-clock"></i> Schedule active - Will run at ${t} for ${scheduleData.timeSchedule.duration_min} minutes`;
          el.className='schedule-status active';
        }
      } else {
        el.innerHTML = '<i class="fas fa-clock"></i> No schedule set';
        el.className='schedule-status inactive';
      }
      const box=document.getElementById('timeLeftBox'); if(box) box.style.display=(scheduleData.timeSchedule.running && scheduleData.timeSchedule.run_until)?'block':'none';
    }

    function setMoistureControl(){
      const enabled = document.getElementById('moistureAutoEnable')?.checked;
      const threshold = parseInt(document.getElementById('moistureThreshold')?.value);
      const target = parseInt(document.getElementById('moistureTarget')?.value);
      if ([threshold,target].some(x=>Number.isNaN(x)) || threshold >= target) { alert('Please enter valid threshold values (threshold < target)'); return; }
      scheduleData.moistureControl = { enabled, threshold, target };
      updateMoistureStatus();
      addLog(`Moisture control ${enabled?'enabled':'disabled'} (${threshold}-${target}%)`);
    }

    function updateMoistureStatus(){
      const el = document.getElementById('moistureStatus'); if(!el) return;
      if (scheduleData.moistureControl.enabled) {
        el.innerHTML = `<i class="fas fa-tint"></i> Auto control active - ON &lt; ${scheduleData.moistureControl.threshold}%, OFF &gt; ${scheduleData.moistureControl.target}%`;
        el.className='schedule-status active';
      } else {
        el.innerHTML = '<i class="fas fa-tint"></i> Moisture automation disabled';
        el.className='schedule-status inactive';
      }
    }

    // ===== Time Left =====
    function handleTimeLeft(running, runUntilEpochSec){
      if (!running || !runUntilEpochSec) { stopTimeLeft(); return; }
      startTimeLeft(runUntilEpochSec);
    }
    function startTimeLeft(until){
      stopTimeLeft();
      const box=document.getElementById('timeLeftBox'), txt=document.getElementById('timeLeftText'); if(!box||!txt) return;
      box.style.display='block';
      function tick(){
        const remain=(until*1000)-Date.now();
        if (remain<=0){ txt.textContent='Time left: 00:00:00 (Finished)'; stopTimeLeft(); return; }
        const hh=Math.floor(remain/3600000), mm=Math.floor((remain%3600000)/60000), ss=Math.floor((remain%60000)/1000);
        txt.textContent=`Time left: ${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
      }
      tick(); timeLeftTimer=setInterval(tick,1000);
    }
    function stopTimeLeft(){ if(timeLeftTimer){ clearInterval(timeLeftTimer); timeLeftTimer=null; } const box=document.getElementById('timeLeftBox'); if(box) box.style.display='none'; }

    // ================== CHART (BARU) ==================
    function initializeChart(){
      const ctx = document.getElementById('sensorChart'); if(!ctx) return;
      chart = new Chart(ctx, {
        type:'line',
        data:{ labels:[], datasets:[
          { label:'Temperature (°C)', data:[], borderColor:'#ff6b6b', backgroundColor:'rgba(255,107,107,.1)', borderWidth:2, fill:false, tension:.35, yAxisID:'y' },
          { label:'Soil Moisture (%)', data:[], borderColor:'#4ecdc4', backgroundColor:'rgba(78,205,196,.1)', borderWidth:2, fill:false, tension:.35, yAxisID:'y1' },
          { label:'pH Level', data:[], borderColor:'#45b7d1', backgroundColor:'rgba(69,183,209,.1)', borderWidth:2, fill:false, tension:.35, yAxisID:'y2' }
        ]},
        options:{
          responsive:true, maintainAspectRatio:false,
          plugins:{
            legend:{ position:'top', labels:{ usePointStyle:true, padding:16, color:getCss('--text-dark') } },
            title:{ display:true, text:'Real-time Sensor Data', color:getCss('--text-dark'), font:{ size:16, weight:'bold' } }
          },
          scales:{
            x:{ ticks:{ maxTicksLimit:10, color:getCss('--text-light') }, grid:{ color:getCss('--border-color') } },
            y:{ position:'left', title:{ display:true, text:'Temperature (°C)', color:'#ff6b6b' }, ticks:{ color:'#ff6b6b' }, grid:{ drawOnChartArea:false } },
            y1:{ position:'right', title:{ display:true, text:'Soil Moisture (%)', color:'#4ecdc4' }, ticks:{ color:'#4ecdc4' }, grid:{ drawOnChartArea:false } },
            y2:{ display:false, position:'right', min:0, max:14 }
          },
          interaction:{ mode:'index', intersect:false },
          animation:{ duration:400 }
        }
      });
    }
    function getCss(v){ return getComputedStyle(document.documentElement).getPropertyValue(v) || '#666'; }

    function addDataPoint(type, value){
      const now = new Date();
      const t = currentRange==='7d' ? now.toLocaleDateString() : now.toLocaleTimeString();
      const needNew = (historicalData.timestamps.length===0 || historicalData.timestamps.at(-1)!==t);
      if (needNew){
        historicalData.timestamps.push(t);
        ['temperature','humidity','ph'].forEach(k => historicalData[k].push(null));
      }
      const idx = historicalData.timestamps.length-1;
      if (type==='temperature') historicalData.temperature[idx]=value;
      if (type==='humidity')    historicalData.humidity[idx]=value;
      if (type==='ph')          historicalData.ph[idx]=value;

      trimPoints();
    }
    function trimPoints(){
      const len = historicalData.timestamps.length;
      if (len>maxDataPoints){
        const cut=len-maxDataPoints;
        ['timestamps','temperature','humidity','ph'].forEach(k => historicalData[k].splice(0,cut));
      }
    }
    function renderChart(){
      if(!chart) return;
      const container=document.getElementById('chartContainer'); if(container) container.classList.add('has-data');
      chart.data.labels = historicalData.timestamps;
      chart.data.datasets[0].data = historicalData.temperature;
      chart.data.datasets[1].data = historicalData.humidity;
      chart.data.datasets[2].data = historicalData.ph;
      chart.update('none');
    }
    async function loadChartData(range){
      let url;
      if(range==='7d'){
        url=`get_hourly.php?days=7`;
      } else if(range==='24h'){
        url=`get_realtime.php?hours=24`;
      } else if(range==='6h'){
        url=`get_realtime.php?hours=6`;
      } else {
        url=`get_realtime.php?hours=1`;
      }
      try{
        const res = await fetch(url);
        const json = await res.json();
        historicalData = { timestamps: [], temperature: [], humidity: [], ph: [] };
        json.data.forEach(r=>{
          const ts = new Date((r.t ?? r.hour_start)*1000);
          const label = range==='7d' ? ts.toLocaleDateString() : ts.toLocaleTimeString();
          historicalData.timestamps.push(label);
          historicalData.temperature.push(r.suhu ?? r.suhu_avg);
          historicalData.humidity.push(r.kelembapan_tanah ?? r.kelembapan_avg);
          historicalData.ph.push(r.ph ?? r.ph_avg);
        });
        trimPoints();
        renderChart();
      } catch(err){
        console.error('Failed to load chart data', err);
      }
    }
    async function updateChartTimeRange(range){
      currentRange = range;
      if (range==='1h') maxDataPoints=60;
      else if (range==='6h') maxDataPoints=72;
      else if (range==='24h') maxDataPoints=96;
      else if (range==='7d') maxDataPoints=168;
      await loadChartData(range);
    }
  </script>
</body>
</html>
